# msa-capstone-project
<img src= "https://t1.daumcdn.net/cfile/tistory/997A00365C79475E04?download">


  
## 👫 Team

   |팀|성명|직급|사번|소속||
   |:----:|:------:|:------:|:------|:------|------|
   |2|🎖서정훈|과장|201600017|서비스혁신센터|제조방산담당/방산운영2팀|
   ||  신세호|대리|202100009|서비스혁신센터|제조방산담당/제조운영팀|
   ||   정호현|사원|201903684|데이터센터|금융운영팀|

# 서비스 시나리오

기능적 요구사항
1. 사용자가 주문을 한다
2. 주문이 시작되면 배송이 시작된다
3. 주문이 시작되면 재고가 감소한다
4. 주문이 취소되면 배송이 취소된다
5. 주문이 취소되면 재고가 증가한다


비기능적 요구사항
1. 마이크로 서비스를 넘나드는 시나리오에 대한 트랜잭션 처리
2. 주문시 재고가 있는지 확인한다
3. 고객이 주문상태를 주문시스템에서 확인할 수 있어야 한다 (CQRS)


# SAGA
## - 구현
> 서비스를 아래와 같은 방법으로 개별적으로 실행한다. 

```
cd order
mvn spring-boot:run
```

```
cd orderView
mvn spring-boot:run
```

```
cd delivery
mvn spring-boot:run
```

```
cd inventory
mvn spring-boot:run
```

* DDD적용
> 4개의 도메인으로 관리되고 있으며 주문(Order), 배송(Delivery), 재고(Inventory), 주문조회(OrderView)으로 구성된다.

```
@Entity
@Table(name="Order_table")
public class Order  {

    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Long id;
    private Long deliveryId;
    private String productName;
    private String productId;
    private Integer qty;
    private String address;
    private String orderStatus;

    @PostPersist
    public void onPostPersist(){
        Ordered ordered = new Ordered();
        BeanUtils.copyProperties(this, ordered);

        onlineshop.external.Inventory inventory = new onlineshop.external.Inventory();
        OrderApplication.applicationContext.getBean(onlineshop.external.InventoryService.class).deductStock(inventory);

        ordered.publishAfterCommit();
    }
    
```

* 서비스 호출흐름(Sync)
> 주문(Order) -> 재고조회(Inventory)간 호출은 동기식으로 일관성을 유지하는 트랜젝션으로 처리

* 고객이 상품,수량을 입력하고 주문 한다.
* 재고차감을 하기위해 FeinClient를 이용하여 인터페이스(Proxy)를 구현한다.
* 재고수량을 확인하여 수문수량 만큼 재고차감이 된 이후 (@PostPersist) 주문이 되도록 처리한다.

```
// InventoryService.java
package onlineshop.external;

import ...

@FeignClient(name="inventory", url="http://inventory:8083")
public interface InventoryService {
    @RequestMapping(method= RequestMethod.GET, path="/inventories")
    public void deductStock(@RequestBody Inventory inventory);

}
```
* 실시간 재고 차감을 위해 상품id 와 주문수량을 입력 받아 재고 차감 수행
* 수량이 부족하면 '재고 부족' 예외처리
* 수량이 충분하면 db 수량 차감 후 결과 리턴
```
@RestController
public class InventoryController {

    @Autowired
    InventoryService inventoryService;

    @PostMapping("/deduct")
    Inventory deduckQty(@RequestBody String data) throws Exception {
        System.out.println(data);

        ObjectMapper mapper = new ObjectMapper();
        Inventory product = null;
        try {
            product = mapper.readValue(data, Inventory.class);
        } catch (IOException e) {
            e.printStackTrace();
        }

        Inventory inventory = inventoryService.getProductByProductId(product.getProductId());

        if(inventory.getQty() < product.getQty()){
            throw new Exception("재고 부족");
        }else{
            inventoryService.decreaseStock(product.getProductId(),product.getQty());
        }

        return inventory;
    }
}
```
* 서비스 호출흐름(Async)
> 주문(Order) -> 배송(delivery)간 처리는 비동기식으로 처리함

* 배송상태를 업데이트 하고 그 내역을 Kafka로 전달

```
package onlineshop.domain;

import ..

@Entity
@Table(name="Delivery_table")
public class Delivery  {

    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Long id;
    private Long orderId;
..

    @PostPersist
    public void onPostPersist(){
        DeliveryStarted deliveryStarted = new DeliveryStarted();
        BeanUtils.copyProperties(this, deliveryStarted);
        deliveryStarted.publishAfterCommit();
    }
```


# CQRS
* 주문 서비스(8081)와 배송 서비스(8082), 재고 서비스(8083)을 각각 실행
```
cd order
mvn spring-boot:run
```

```
cd delivery
mvn spring-boot:run
```

```
cd inventory
mvn spring-boot:run
```

* 상품 주문 
```
gitpod /workspace/msa-capstone-project (main) $ http POST :8081/orders productId=1 qty=1
```

``` 
HTTP/1.1 201 
Content-Type: application/json;charset=UTF-8
Date: Tue, 17 May 2022 05:14:37 GMT
Location: http://localhost:8081/orders/235
Transfer-Encoding: chunked

{
    "_links": {
        "order": {
            "href": "http://localhost:8081/orders/235"
        },
        "self": {
            "href": "http://localhost:8081/orders/235"
        }
    },
    "address": null,
    "deliveryId": null,
    "orderStatus": null,
    "productId": "1",
    "productName": null,
    "qty": 1
}


```

* 카프카 consumer 이벤트 모니터링
```
/usr/local/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic shopmall --from-beginning
```
```
{"eventType":"Grabbed","timestamp":"20220329041223","id":1,"taxiId":1,"taxiNum":"서울32저4703","me":true}
{"eventType":"Allocated","timestamp":"20220329041223","id":1,"grabId":1,"taxiId":1,"taxiNum":"서울32저4703","me":true}
```

* orderView 서비스를 실행

```
cd orderView
mvn spring-boot:run
```
* orderView의 Query Model을 통해 주문상태와 배송상태를 통합조회
Query Model 은 발생한 모든 이벤트를 수신하여 자신만의 View로 데이터를 통합 조회 가능하게 함
```
http localhost:8084/orderViews/235
```

```
gitpod /workspace/msa-capstone-project (main) $ http :8084/orderViews/235
HTTP/1.1 200 
Content-Type: application/hal+json;charset=UTF-8
Date: Tue, 17 May 2022 06:07:01 GMT
Transfer-Encoding: chunked

{
    "_links": {
        "orderView": {
            "href": "http://localhost:8084/orderViews/235"
        },
        "self": {
            "href": "http://localhost:8084/orderViews/235"
        }
    },
    "address": null,
    "deliveryStatus": "delivery_started",
    "orderStatus": "ordered",
    "productId": 1,
    "productName": null,
    "qty": 1
}
```

* 주문 및 배송 정보가 orderView에 전달되어 상태 변경 된 것을 통합 조회 가능함


# Correlation / Compensation

# Req / Resp (feign client)

* Interface 선언으로 Http Client 생성
* Dependency 추가

```
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>
```
* Controller
```
package com.example.feigntest.controller;

import ...

@Slf4j
@RestController
@RequiredArgsConstructor
public class HTaxiFeignController {

    private final HTaxiFeignService HTaxiFeignService;

+   @GetMapping(value = "/v1/github/{owner}/{repo}")
    public List<Contributor> getHTaxiContributors(@PathVariable String owner , @PathVariable String repo){
        return HTaxiFeignService.getContributor(owner,repo);
    }
}
```
